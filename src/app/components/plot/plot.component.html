<div class="d-flex flex-row gap-4">
  <!-- KPI a sinistra -->
  <div class="flex-shrink-0" style="min-width: 300px;">
    <app-kpi-box [kpisData]="kpisData" [formatNumber]="formatNumber"></app-kpi-box>
  </div>

  <!-- Grafico al centro + widget opzionale -->
  <div class="flex-grow-1 d-flex flex-row gap-4">
    <!-- Parte centrale: controlli + grafico -->
    <div class="flex-grow-1">
      <app-plot-controls
        [showAllSubsystems]="showAllSubsystems"
        [mostraPunti]="mostraPunti"
        [monoDimensionale]="monoDimensionale"
        [heatmapAttiva]="heatmapAttiva"
        [sottosistemi]="sottosistemi"
        [sottosistemaSelezionato]="sottosistemaSelezionato"
        (showAllSubsystemsChange)="showAllSubsystems = $event"
        (mostraPuntiChange)="mostraPunti = $event"
        (monoDimensionaleChange)="monoDimensionale = $event"
        (heatmapAttivaChange)="heatmapAttiva = $event"
        (sottosistemaSelezionatoChange)="sottosistemaSelezionato = $event"
        (funzioneChange)="onFunzioneChange()"
        (heatmapToggle)="onHeatmapToggle()"
      ></app-plot-controls>

      <div #chartLib style="min-height: 400px; position: relative;">
        <div *ngIf="loading" class="loading-spinner">Loading...</div>
        <!-- Qui va il grafico vero e proprio -->
      </div>

      <!-- Info e note SEMPRE visibili -->
      <div class="row mt-4">
        <div class="col">
          <div class="p-3 border rounded bg-light h-100">
            <h6 class="mb-2">{{ 'plot.infoTitle' | translate }}</h6>
            <p class="small text-muted mb-0">
              {{ 'plot.infoText' | translate }}
            </p>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col">
          <div class="p-3 border rounded bg-light h-100">
            <h6 class="mb-2">{{ 'plot.notesTitle' | translate }}</h6>
            <it-textarea
              label="{{ 'plot.notesLabel' | translate }}"
              [(ngModel)]="noteUtente"
            ></it-textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Colonna destra: widget solo se editing -->
    <div [class.visible]="editing"  class="plot-editor-sidebar flex-shrink-0">
      <app-plot-editor-widget   [widgets]="widgets"

    ></app-plot-editor-widget>
    </div>
  </div>
</div>
