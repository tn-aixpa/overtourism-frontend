<it-card background="true" class="p-4 mb-4">
  <div class="position-absolute top-0 end-0 m-3 d-flex gap-2">
    <it-modal #editProposalModal size="lg">
      <ng-container modalTitle>
        {{ 'problems.proposals.edit_title' | translate }}
      </ng-container>
    
      <app-proposal-create 
        [problemId]="problemId"
        [proposalToEdit]="proposal ?? undefined"
        (proposalCreated)="onProposalEdited()"
        (problemSaved)="onProposalEdited()"
        (problemCancel)="onProposalCanel()"
        >
      </app-proposal-create>
    </it-modal>
    
    <button itButton="primary" (click)="editProposalModal.show()">
      <span class="material-icons align-middle">edit</span> Modifica
    </button>
    <button itButton="danger" size="sm" (click)="openDeleteModalProposal()">
      <span class="material-icons align-middle">delete</span> Elimina
    </button>
  </div>
    <h3 class="mb-4">{{ proposal?.proposal_title }}</h3>
  
    <!-- Tabella info proposta -->
    <table class="table table-borderless mb-4">
      <tbody>
        <tr>
          <td class="fw-bold w-25" >{{ 'problems.proposals.tableHeader.title' | translate }}</td>
          <td [ngClass]="{'text-muted fst-italic': !proposal?.proposal_title}">{{ proposal?.proposal_title | emptyField:'(vuoto)'}}</td>
        </tr>
        <tr>
          <td class="fw-bold w-25" >{{ 'problems.proposals.tableHeader.description' | translate }}</td>
          <td [ngClass]="{'text-muted fst-italic': !proposal?.proposal_description}">{{ proposal?.proposal_description | emptyField:'(vuoto)'}}</td>
        </tr>
        <tr>
          <td class="fw-bold w-25" >{{ 'problems.proposals.tableHeader.context' | translate }}</td>
          <td [ngClass]="{'text-muted fst-italic': !proposal?.context}">{{ proposal?.context | emptyField:'(vuoto)'}}</td>
        </tr>
        <tr>
          <td class="fw-bold w-25" >{{ 'problems.proposals.tableHeader.impact' | translate }}</td>
          <td [ngClass]="{'text-muted fst-italic': !proposal?.impact}">{{ proposal?.impact | emptyField:'(vuoto)'}}</td>
        </tr>
        <tr>
          <td class="fw-bold w-25">{{ 'problems.proposals.tableHeader.status' | translate }}</td>
          <td>
            <span class="badge bg-secondary">{{ proposal?.status }}</span>
          </td>
        </tr>
        <tr>
          <td class="fw-bold w-25">{{ 'problems.proposals.tableHeader.resources' | translate }}</td>
          <td>
            <ul *ngIf="proposal?.resources?.length">
              <li *ngFor="let resource of proposal?.resources">
                <a [href]="resource" target="_blank">{{ resource }}</a>
              </li>
            </ul>
            <span *ngIf="!proposal?.resources?.length">â€”</span>
          </td>
        </tr>
      </tbody>
    </table>
  </it-card>
  
  <!-- Sezione Scenari -->
  <h3 class="mb-2 mt-4" style="font-size: 1.25rem;">{{ 'scenari.title' | translate }}</h3>
  
  <!-- Pulsante comparazione -->
  <button itButton="primary" size="sm" class="mb-4" (click)="toggleComparazione()" 
          [disabled]="scenari.length < 2">
    {{ comparazioneAttiva ? ('scenari.disable_compare' | translate) : ('scenari.enable_compare' | translate) }}
  </button>
  
  <div class="table-responsive">
    <it-table>
      <ng-container thead>
        <tr>
          <th *ngIf="comparazioneAttiva" class="text-start align-middle"></th>
          <th class="text-start align-middle">#</th>
          <th class="text-start align-middle">{{ 'scenari.name' | translate }}</th>
          <th class="text-start align-middle">{{ 'scenari.description' | translate }}</th>
          <th class="text-start align-middle">{{ 'scenari.parameters' | translate }}</th>
          <th class="text-start align-middle">{{ 'scenari.actions' | translate }}</th>
        </tr>
      </ng-container>
      <ng-container tbody>
        <tr *ngFor="let scenario of scenari; let i = index"
            [ngClass]="{'bg-custom-light': i % 2 === 0, 'bg-white': i % 2 !== 0}"
            style="cursor: pointer;">
          <td *ngIf="comparazioneAttiva">
            <it-checkbox
            [(ngModel)]="checkboxStates[scenario.scenario_id]"
            [disabled]="!checkboxStates[scenario.scenario_id] && selectedScenari.length >= 2"
            (click)="$event.stopPropagation()"
            (ngModelChange)="onScenarioCheck(scenario, $event)">
          </it-checkbox>
          </td>
          <td class="text-start align-middle">{{ i + 1 }}</td>
          <td class="text-start align-middle" [ngClass]="{'text-muted fst-italic': !scenario?.scenario_name}">{{ scenario.scenario_name |emptyField:'(vuoto)'}}</td>
          <td class="text-start align-middle" [ngClass]="{'text-muted fst-italic': !scenario?.scenario_description}">{{ scenario.scenario_description |emptyField:'(vuoto)'}}</td>
          <td class="text-start align-middle">
            <button
              *ngIf="hasParams(scenario) && widgets"
              class="btn btn-sm btn-icon text-primary"
              [itPopover]="getDiffDescription(scenario)"
              [popoverTitle]="'scenari.parametersChanged' | translate"
              [popoverPlacement]="'left'"
              [popoverContainer]="'body'"
              popoverTrigger="focus"
              popoverHtml="true"
              (click)="$event.stopPropagation()"
              aria-label="Visualizza parametri">
              <span class="material-icons align-middle">description</span>
            </button>
          </td>
          <td class="text-start align-middle">
            <div class="d-flex flex-wrap justify-content-start gap-2">
              <button class="btn btn-sm btn-icon text-primary" 
                      (click)="goToScenario(scenario); $event.stopPropagation()"
                      [disabled]="comparazioneAttiva" 
                      aria-label="Dettaglio scenario">
                <span class="material-icons">visibility</span>
              </button>
              
              <button *ngIf="scenario.scenario_id !== 'model_0'" 
                      class="btn btn-sm btn-icon text-primary"
                      (click)="openDeleteScenarioModal(scenario); $event.stopPropagation()" 
                      [disabled]="comparazioneAttiva"
                      aria-label="Elimina scenario">
                <span class="material-icons">delete</span>
              </button>
            </div>
          </td>
        </tr>
      </ng-container>
    </it-table>
  </div>
  
  <div *ngIf="comparazioneAttiva && selectedScenari.length === 2" class="mt-3">
    <button itButton="primary" (click)="confrontaScenari()">
      {{ 'scenari.compare_selected' | translate }}
    </button>
  </div>
  
  <app-back-button></app-back-button>
  
  <!-- Modal elimina scenario -->
  <it-modal #deleteModal>
    <ng-container modalTitle>
      {{ 'scenari.confirm_delete_title' | translate }}
    </ng-container>
  
    <p>
      {{ 'scenari.confirm_delete_message' | translate:{name: scenarioToDelete?.scenario_name} }}
    </p>
  
    <ng-container footer>
      <button itButton="outline-primary" (click)="onCancelDeleteScenario()">
        {{ 'common.cancel' | translate }}
      </button>
      <button itButton="danger" (click)="onConfirmDeleteScenario()">
        {{ 'common.delete' | translate }}
      </button>
    </ng-container>
  </it-modal>
  <it-modal #proposalModal size="lg">
    <ng-container modalTitle>
      {{ proposalToEdit ? ('problems.proposals.edit_title' | translate) : ('problems.proposals.add_title' | translate) }}
    </ng-container>
    <app-proposal-create
      [problemId]="problemId"
      [proposalToEdit]="proposalToEdit ?? undefined"
      
      (proposalCreated)="onProposalCreatedModal()">
    </app-proposal-create>
  
    <ng-container footer>
      <button itButton="outline-primary" (click)="onCancelDeleteProposal()">
        {{ 'common.cancel' | translate }}
      </button>
    </ng-container>
  </it-modal>
  <it-modal #deleteProposalModal>
    <ng-container modalTitle>
      {{ 'problems.proposals.confirm_delete_title' | translate }}
    </ng-container>
  
    <p>
      {{ 'problems.proposals.confirm_delete_message' | translate:{name: proposal?.proposal_title} }}
    </p>
  
    <ng-container footer>
      <button itButton="outline-primary" (click)="onCancelDeleteProposal()">
        {{ 'common.cancel' | translate }}
      </button>
      <button itButton="danger" (click)="onConfirmDeleteProposal()">
        {{ 'common.delete' | translate }}
      </button>
    </ng-container>
  </it-modal>