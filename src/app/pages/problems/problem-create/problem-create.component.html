<it-card background="true" class="p-4">
  <h3 class="mb-4">{{ 'problems.createTitle' | translate }}</h3>

  <form (ngSubmit)="onSubmit()" #form="ngForm">
    <div class="table-responsive mb-4">
      <table class="table table-borderless">
        <tbody>
          <!-- Titolo -->
          <tr>
            <td class="fw-bold w-25">
              <label for="title">{{ 'problems.fields.title' | translate }}</label>
            </td>
            <td>
              <ng-container *ngIf="!saved; else titleLabel">
                <it-input id="title" name="name" [(ngModel)]="model.name" required
                          placeholder="{{ 'problems.fields.titlePlaceholder' | translate }}"></it-input>
              </ng-container>
              <ng-template #titleLabel>{{ model.name }}</ng-template>
            </td>
          </tr>

          <!-- Obiettivo -->
          <tr>
            <td class="fw-bold w-25">
              <label for="objective">{{ 'problems.fields.objective' | translate }}</label>
            </td>
            <td>
              <ng-container *ngIf="!saved; else objectiveLabel">
                <it-textarea id="objective" name="objective" [(ngModel)]="model.objective" [rows]="4"
                             placeholder="{{ 'problems.fields.objectivePlaceholder' | translate }}"></it-textarea>
              </ng-container>
              <ng-template #objectiveLabel>{{ model.objective }}</ng-template>
            </td>
          </tr>

          <!-- Descrizione del problema -->
          <tr>
            <td class="fw-bold w-25">
              <label for="descriptionProblem">{{ 'problems.fields.descriptionProblem' | translate }}</label>
            </td>
            <td>
              <ng-container *ngIf="!saved; else descriptionLabel">
                <it-textarea id="descriptionProblem" name="descriptionProblem" [(ngModel)]="model.descriptionProblem"
                             [rows]="4"
                             placeholder="{{ 'problems.fields.descriptionProblemPlaceholder' | translate }}"></it-textarea>
              </ng-container>
              <ng-template #descriptionLabel>{{ model.descriptionProblem }}</ng-template>
            </td>
          </tr>

          <!-- Categoria -->
          <tr>
            <td class="fw-bold w-25">
              <label>{{ 'problems.fields.category' | translate }}</label>
            </td>
            <td>
              <ng-container *ngIf="!saved; else categoryLabel">
                <fieldset>
                  <legend>{{ 'problems.fields.group' | translate }}</legend>
                  <it-checkbox *ngFor="let cat of availableCategories"
                               [(ngModel)]="model.categories[cat.key]"
                               name="category_{{cat.key}}"
                               label="{{ cat.label | translate }}"
                               inline="true">
                  </it-checkbox>
                </fieldset>
              </ng-container>
              <ng-template #categoryLabel>
                <span *ngFor="let cat of availableCategories; let last=last">
                  <span *ngIf="model.categories[cat.key]">{{ cat.label | translate }}</span>
                  <span *ngIf="!last">, </span>
                </span>
              </ng-template>
            </td>
          </tr>

          <!-- Dati e tecnologie rilevanti -->
          <tr>
            <td class="fw-bold w-25">
              <label>{{ 'problems.fields.resources' | translate }}</label>
            </td>
            <td>
              <ng-container *ngIf="!saved">
                <!-- Aggiungi nuova risorsa -->
                <div class="d-flex align-items-center mb-3">
                  <it-input [(ngModel)]="newResource" name="newResource"
                            placeholder="{{ 'problems.fields.resourcePlaceholder' | translate }}"
                            style="flex: 1; min-width: 0;">
                  </it-input>
                  <button type="button" class="btn btn-outline-primary ms-2 rounded-circle p-0"
                          style="width:36px; height:36px; display:flex; align-items:center; justify-content:center;"
                          (click)="addResource()">
                    <span class="material-icons" style="font-size:22px;">add</span>
                  </button>
                </div>
              </ng-container>

              <!-- Lista risorse -->
              <div class="d-flex flex-column gap-2">
                <div *ngFor="let res of model.resources; let i = index"
                     class="border rounded p-2 d-flex justify-content-between align-items-start"
                     style="background-color: #f8f9fa;">
                  <div style="word-break: break-word; flex: 1;">
                    <a *ngIf="isUrl(res)" [href]="res" target="_blank" class="text-decoration-none">{{ res }}</a>
                    <span *ngIf="!isUrl(res)">{{ res }}</span>
                  </div>
                  <button *ngIf="!saved" type="button" class="btn-close btn-close-sm ms-2 mt-1"
                          aria-label="Remove" (click)="removeResource(i)"></button>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- footer grigio con pulsante salva -->
    <div class="border-top pt-3 mt-4 d-flex justify-content-end">
      <button *ngIf="!saved" itButton="primary" type="submit" [disabled]="form.invalid ?? false">
        {{ 'common.save' | translate }}
      </button>
    </div>
  </form>

  <!-- Pulsante aggiungi proposta -->
  <div *ngIf="saved && !showProposalForm" class="mt-3">
    <button itButton="primary" (click)="showProposalForm = true">
      {{ 'problems.fields.addProposal' | translate }}
    </button>
  </div>

  <!-- Componente proposta -->
  <app-proposal-create *ngIf="showProposalForm"
></app-proposal-create>
   <!-- <div *ngIf="showProposalForm">
    proposta
   </div>    [problemId]="savedProblemId -->
</it-card>

<app-back-button></app-back-button>
